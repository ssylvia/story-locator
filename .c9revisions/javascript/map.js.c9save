{"ts":1359478369683,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"dojo.require(\"esri.map\");\r\ndojo.require(\"esri.dijit.Legend\");\r\ndojo.require(\"esri.dijit.Scalebar\");\r\ndojo.require(\"esri.arcgis.utils\");\r\ndojo.require(\"esri.IdentityManager\");\r\ndojo.require(\"dijit.dijit\"); // optimize: load dijit layer\r\ndojo.require(\"dijit.layout.BorderContainer\");\r\ndojo.require(\"dijit.layout.ContentPane\");\r\ndojo.require(\"esri.dijit.Popup\");\r\n\r\nvar map, _maps = [], _popup = [], _mapInfo = [], urlObject, _csvLayers = [], _storyPoints = [], mapsLoaded = 0, mapsReady = false;\r\n\r\nfunction initMap() {\r\n      patchID();\r\n      \r\n      if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\r\n        configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\r\n      }\r\n      esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);  \r\n      \r\n\r\n\r\n      if(!configOptions.sharingurl){\r\n        configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\r\n      }\r\n      esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\r\n       \r\n      if(!configOptions.proxyurl){   \r\n        configOptions.proxyurl = location.protocol + '//' + location.host + \"/sharing/proxy\";\r\n      }\r\n\r\n      esri.config.defaults.io.proxyUrl =  configOptions.proxyurl;\r\n\r\n      esri.config.defaults.io.alwaysUseProxy = false;\r\n      \r\n      urlObject = esri.urlToObject(document.location.href);\r\n      urlObject.query = urlObject.query || {};\r\n      \r\n      if(urlObject.query.title){\r\n        configOptions.title = urlObject.query.title;\r\n      }\r\n      if(urlObject.query.subtitle){\r\n        configOptions.title = urlObject.query.subtitle;\r\n      }\r\n      if(urlObject.query.webmap){\r\n        configOptions.webmap = urlObject.query.webmap;      \r\n      } \r\n      if(urlObject.query.bingMapsKey){\r\n        configOptions.bingmapskey = urlObject.query.bingMapsKey;      \r\n      }\r\n\t  \r\n      \r\n     if (configOptions.webmaps.length === 1){\r\n         $(\"#tabs\").hide();\r\n     }\r\n     \r\n   \t createMaps();\r\n}\r\n\r\n\r\nfunction createMaps(){\r\n\t\t\r\n\tdojo.forEach(configOptions.webmaps,function(webmap,i){\r\n\t\t\r\n\t  $(\"#map\").append(\"<div id='mapDiv\"+i+\"' class='mapDiv'></div>\");\r\n\t  $(\"#storyPoints\").append(\"<div id='story\"+i+\"' class='story'></div>\");\r\n\t  $(\"#tabs\").append(\"<div id='tab\"+i+\"' class='tab'></div>\");\r\n\t  $(\"#legendDiv\").append(\"<div id='legendDiv\"+i+\"' class='legendDiv'></div>\");\r\n\t  \r\n\t  $(\"#tab\"+i).data(\"count\", i);\r\n\t  \r\n\t  var popup = new esri.dijit.Popup({\r\n\t\thighlight:true\r\n      }, dojo.create(\"div\"));\r\n\t  \r\n\t  _popup[i] = popup;\r\n\r\n      var mapDeferred = esri.arcgis.utils.createMap(webmap.id, \"mapDiv\"+i, {\r\n        mapOptions: {\r\n          slider: true,\r\n          nav: false,\r\n          wrapAround180:true,\r\n\t\t  infoWindow:popup\r\n        },\r\n        ignorePopups:false,\r\n        bingMapsKey: configOptions.bingmapskey\r\n      });\r\n\r\n      mapDeferred.addCallback(function (response) {\r\n\t\t  \r\n        mapInfo = {\"title\": response.itemInfo.item.title || \"\",\r\n\t\t\t\t   \"subtitle\": response.itemInfo.item.snippet || \"\",\r\n\t\t\t\t   \"description\": response.itemInfo.item.description || \"\"};\r\n        \r\n\t\t$(\"#tab\"+i).html(mapInfo.title);\r\n\t\t\r\n        map = response.map;\r\n\t\t_maps[i] = map;\r\n\t\t_mapInfo[i] = mapInfo;\r\n\t\t\r\n\t\tdojo.connect(map,\"onUpdateEnd\",hideLoader);\r\n\t\t  \r\n        var layers = response.itemInfo.itemData.operationalLayers;\r\n\t\t\r\n        if(map.loaded){\r\n          initUI(layers, i);\r\n\t\t  findLayers(layers,i);\r\n        }\r\n        else{\r\n          dojo.connect(map,\"onLoad\",function(){\r\n            initUI(layers, i);\r\n\t\t\tfindLayers(layers,i);\r\n          });\r\n        }\r\n        //resize the map when the browser resizes\r\n        dojo.connect(dijit.byId('map'), 'resize', map,map.resize);\r\n       });\r\n\r\n      mapDeferred.addErrback(function (error) {\r\n          alert(\"Unable to create map: \" + \" \" + dojo.toJson(error.message));\r\n      });\r\n\t});\r\n}\r\n\r\n\r\n    function initUI(layers, i) {\r\n      //add chrome theme for popup\r\n      dojo.addClass(map.infoWindow.domNode, \"chrome\");\r\n      //add the scalebar \r\n      var scalebar = new esri.dijit.Scalebar({\r\n        map: map,\r\n        scalebarUnit:\"english\" //metric or english\r\n      });\r\n\r\n      var layerInfo = buildLayersList(layers);      \r\n\r\n      \r\n      if(layerInfo.length > 0){\r\n        var legendDijit = new esri.dijit.Legend({\r\n          map:map,\r\n          layerInfos:layerInfo\r\n        },\"legendDiv\"+i);\r\n        legendDijit.startup();\r\n      }\r\n      else{\r\n        dojo.byId('legendDiv'+i).innerHTML = '';\r\n      }\r\n\t}\r\n\t\r\n\tfunction buildLayersList(layers){\r\n      //build a list of layers for the legend.\r\n      var layerInfos = [];\r\n      dojo.forEach(layers, function(mapLayer, index) {\r\n\t\tif(mapLayer.id.search(\"csv\") != 0) {\r\n\t\t\tif(mapLayer.featureCollection){\r\n\t\t\t  if (mapLayer.featureCollection.layers && mapLayer.featureCollection.showLegend) {\r\n\t\t\t\tif(mapLayer.featureCollection.layers.length === 1){\r\n\t\t\t\t  layerInfos.push({\"layer\":mapLayer.featureCollection.layers[0].layerObject,\"title\":mapLayer.title});\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t  dojo.forEach(mapLayer.featureCollection.layers, function(layer) {\r\n\t\t\t\t\t layerInfos.push({\r\n\t\t\t\t\t\tlayer: layer.layerObject, \r\n\t\t\t\t\t\ttitle: layer.layerDefinition.name\r\n\t\t\t\t\t  });\r\n\t\t\t\t  }); \r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t  }\r\n\t\t\t }else if (mapLayer.layerObject){\r\n\t\t\t\tlayerInfos.push({layer:mapLayer.layerObject, title:mapLayer.title});\r\n\t\t\t }\r\n\t\t}\r\n      });\r\n\t\t\treturn layerInfos;\r\n}\r\n\t\r\nfunction hideLoader(){\r\n\tif (mapsLoaded <= configOptions.webmaps.length){\r\n\t\tif (mapsLoaded == configOptions.webmaps.length - 1){\r\n\t\t\tmapsReady = true;\r\n\t\t\tmapsLoaded++\r\n\t\t\tdocument.title = configOptions.title|| _mapInfo[0].title || \"\";\r\n        \tdojo.byId(\"title\").innerHTML = configOptions.title || _mapInfo[0].title || \"\";\r\n        \tdojo.byId(\"subtitle\").innerHTML = configOptions.subtitle|| _mapInfo[0].subtitle || \"\";\r\n\t\t\tdojo.byId(\"description\").innerHTML = configOptions.description|| _mapInfo[0].description || \"\";\r\n\t\t\t$(\"#tab0\").addClass('selectedStory');\r\n\t\t\t$(\"#legendDiv0\").show();\r\n\t\t\tdojo.forEach(configOptions.webmaps,function(map,i){\r\n\t\t\t\tif (i != 0){\r\n\t\t\t\t\t$(\"#mapDiv\"+i).hide();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t$(\"#mapBlind\").fadeOut();\r\n\t\t\t$(\"#loadingCon\").hide();\r\n            dijit.byId(\"mainWindow\").layout();\r\n\t\t}\r\n\t\telse{\r\n\t\t\tmapsLoaded++\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\nfunction patchID() {  //patch id manager for use in apps.arcgis.com\r\n       esri.id._isIdProvider = function(server, resource) {\r\n       // server and resource are assumed one of portal domains\r\n \r\n       var i = -1, j = -1;\r\n \r\n       dojo.forEach(this._gwDomains, function(domain, idx) {\r\n         if (i === -1 && domain.regex.test(server)) {\r\n           i = idx;\r\n         }\r\n         if (j === -1 && domain.regex.test(resource)) {\r\n           j = idx;\r\n         }\r\n       });\r\n \r\n       var retVal = false;\r\n   \r\n       if (i > -1 && j > -1) {\r\n         if (i === 0 || i === 4) {\r\n           if (j === 0 || j === 4) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 1) {\r\n           if (j === 1 || j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 2) {\r\n           if (j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 3) {\r\n           if (j === 3) {\r\n             retVal = true;\r\n           }\r\n         }\r\n       }\r\n \r\n       return retVal;\r\n     };    \r\n    }"]],"start1":0,"start2":0,"length1":0,"length2":7385}]],"length":7385}
