{"ts":1359478372111,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"$(document).ready(function(e) {\r\n\t  $(\"#legendToggle\").click(function(){\r\n\t\tif ($(\"#legendDiv\").css('display')=='none'){\r\n\t\t  $(\"#legTogText\").html('MAP LEGEND ▲');\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html('MAP LEGEND ▼');\r\n\t\t}\r\n\t\t$(\"#legendDiv\").slideToggle();\r\n\t  });\r\n    });\r\n\r\nvar popupOpen = false,\r\n\t j = 0,\r\n    _storyData = [],\r\n    selection,\r\n    mapPoint;\r\n\r\nvar checkImg = function(obj){\r\n\r\n\tvar img = new RegExp (/(?:.jpe?g|.gif|.png)/i);\r\n\tvar url = new RegExp (/http/i);\r\n\r\n\tfor (var prop in obj){\r\n\t\tif (typeof(obj[prop]) == 'string'){\r\n\t\t\tif (img.test((obj[prop])) == true && url.test((obj[prop])) == true){\r\n\t\t\t\treturn(obj[prop]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\nvar findTitle = function(obj){\r\n\r\n\tvar udrScr = new RegExp (/\"_\"/i);\r\n\tvar url = new RegExp (/http/i);\r\n\r\n\tvar title = null;\r\n\tfor (var prop in obj){\r\n\t\tif (typeof(obj[prop]) == 'string'){\r\n\t\t\tif (title == null && udrScr.test((obj[prop])) == false && (obj[prop]).length > 1 && url.test((obj[prop])) == false){\r\n\t\t\t\ttitle = obj[prop];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn (title);\r\n};\r\n\r\nfunction findLayers(layers,index){\r\n\tvar csvLayers = [];\r\n\tdojo.forEach(layers,function(layer){\r\n\t\tif(layer.id.search(\"csv\") == 0 && layer.visibility == true){\r\n\t\t\tdojo.forEach(layer.featureCollection.layers,function(lyr){\r\n\t\t\t\tcsvLayers.push(lyr.layerObject);\r\n\t\t\t});\r\n\t\t}\r\n\t\telse if(layer.id.search(\"featColl\") == 0 && layer.visibility == true){\r\n\t\t\tdojo.forEach(layer.featureCollection.layers,function(lyr){\r\n\t\t\t\tcsvLayers.push(lyr.layerObject);\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\t_csvLayers[index] = csvLayers;\r\n\tgenerateGraphics(index);\r\n}\r\n\r\nfunction generateGraphics(index){\r\n\tvar shaded = true;\r\n\tdojo.forEach(_csvLayers[index],function(layer,i){\r\n\t\tif (i < 2){\r\n\t\t\tlayer.hide();\r\n\r\n\t\t\t$(\"#story\"+index).append(\"<div id='story\"+index+\"group\"+i+\"' class='group'></div>\");\r\n\r\n\t\t\tvar sp = new esri.layers.GraphicsLayer();\r\n\t\t\tmap.addLayer(sp);\r\n\t\t\t_storyPoints[index] = sp;\r\n\r\n\t\t\tif (layer.graphics[0].attributes.order){\r\n\t\t\t\tlayer.graphics.sort(function(a,b){\r\n\t\t\t\t\treturn a.attributes.order - b.attributes.order;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tdojo.forEach(layer.graphics,function(graphic,j){\r\n\t\t\t\tif (j < 99){\r\n\t\t\t\t\tif (shaded == true){\r\n\t\t\t\t\t\tshaded = false;\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i).append(\"<div id='story\"+index+\"group\"+i+\"point\"+j+\"' class='storyPoint' title='Click for more information'></div>\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\tshaded = true;\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i).append(\"<div id='story\"+index+\"group\"+i+\"point\"+j+\"' class='storyPoint storyPointShaded' title='Click for more information '></div>\");\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).data(\"attributes\", graphic.attributes);\r\n\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).data(\"geometry\", graphic.geometry);\r\n\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).data(\"infoWindow\", layer.infoTemplate);\r\n\r\n\t\t\t\t\tvar group;\r\n\t\t\t\t\tvar fileChange;\r\n\t\t\t\t\tif (i == 2){\r\n\t\t\t\t\t\tgroup = 'green';\r\n\t\t\t\t\t\tfileChange = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (i == 1){\r\n\t\t\t\t\t\tgroup = 'blue';\r\n\t\t\t\t\t\tfileChange = 'b';\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\tgroup = 'red';\r\n\t\t\t\t\t\tfileChange = '';\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar pt = graphic.geometry;\r\n\t\t\t\t\tvar attr = graphic.attributes;\r\n\t\t\t\t\tvar sym = new esri.symbol.PictureMarkerSymbol(\"images/icons/\"+group+\"/NumberIcon\"+fileChange+(j+1)+\".png\", 22, 28).setOffset(3,8);\r\n\t\t\t\t\tvar info = layer.infoTemplate;\r\n\r\n\t\t\t\t\tif (graphic.attributes.order){\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).append(\"<div id='story\"+index+\"group\"+i+\"indexCon\"+j+\"' class='indexCon \"+group+\"'><div id='story\"+index+\"group\"+i+\"pointIndex\"+j+\"' class='pointIndex'>\"+graphic.attributes.order+\"</div></div>\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).append(\"<div id='story\"+index+\"group\"+i+\"indexCon\"+j+\"' class='indexCon \"+group+\"'><img id='story\"+index+\"group\"+i+\"pointIndex\"+j+\"' class='pointIndex' src='images/icons/\"+group+\"/NumberIcon\"+fileChange+(j+1)+\".png'></div>\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).append(\"<div id='story\"+index+\"group\"+i+\"indexCon\"+j+\"' class='indexCon \"+group+\"'><div id='story\"+index+\"group\"+i+\"pointIndex\"+j+\"' class='pointIndex'>\"+(j+1)+\"</div></div>\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\r\n\t\t\t\t\tvar image = graphic.attributes.img || checkImg(graphic.attributes);\r\n\t\t\t\t\tvar ifImg = true;\r\n\r\n\t\t\t\t\tif (image != null && image != \"http://www.landscope.org/_res/img/contentTypeThumbnails/articleSmall.png\"){\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).append(\"<div id='story\"+index+\"group\"+i+\"imgCon\"+j+\"' class='imgCon'><img id='story\"+index+\"group\"+i+\"img\"+j+\"' class='spImg' src='\"+image+\"' alt=''></div>\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\tifImg = false;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar title = graphic.attributes.title || findTitle(graphic.attributes);\r\n\r\n\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).data(\"title\", title);\r\n\r\n\t\t\t\t\tif (title != null){\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"point\"+j).append(\"<div id='story\"+index+\"group\"+i+\"textCon\"+j+\"' class='textCon'><p id='story\"+index+\"group\"+i+\"titleText\"+j+\"' class='titleText'>\"+title+\"</p></div>\");\r\n\r\n\t\t\t\t\t\tvar textWidth;\r\n\r\n\t\t\t\t\t\tif (ifImg == true){\r\n\t\t\t\t\t\t\ttextWidth = (($(\".storyPoint\").width()) - 115);\r\n\t\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"textCon\"+j).css('left',115);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\ttextWidth = (($(\".storyPoint\").width()) - 35);\r\n\t\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"textCon\"+j).css('left',35);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$(\"#story\"+index+\"group\"+i+\"textCon\"+j).width(textWidth);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tattr.displayTitle = title;\r\n\r\n\t\t\t\t\tsp.add(new esri.Graphic(pt,sym,attr,info));\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\r\n\tstartUpListeners(index);\r\n\r\n\t$(\".titleText\").ellipsis();\r\n}\r\n\r\nfunction startUpListeners(index){\r\n\tdojo.connect(_storyPoints[index],\"onMouseOver\",function(){\r\n\t\t_maps[index].setCursor('pointer');\r\n\t\tevent.graphic.setSymbol(event.graphic.symbol.setHeight(34).setWidth(27).setOffset(3,10));\r\n        if (popupOpen == false){\r\n    \t\t$(\"#hoverInfo\").html(event.graphic.attributes.displayTitle);\r\n\t\t\tvar pt = _maps[index].toScreen(event.graphic.geometry);\r\n\t\t\thoverInfoPos(pt.x,pt.y);\r\n\t\t}\r\n\t});\r\n\tdojo.connect(_storyPoints[index],\"onMouseOut\",function(){\r\n\t\t_maps[index].setCursor('default');\r\n\t\tevent.graphic.setSymbol(event.graphic.symbol.setHeight(28).setWidth(22).setOffset(3,8));\r\n        $(\"#hoverInfo\").hide();\r\n\t});\r\n\tdojo.connect(_maps[index],\"onClick\",function(){\r\n\t\tpopupOpen = true;\r\n\t});\r\n\tdojo.connect(_popup[index],\"onHide\",function(){\r\n\t\tpopupOpen = false;\r\n\t\t_popup[index].clearFeatures();\r\n        $(\".storyPoint\").removeClass('selection');\r\n\t});\r\n\tdojo.connect(_storyPoints[index], \"onClick\", function(event) {\r\n        _popup[index].hide();\r\n        var scrollTop = ($(\"#storyPoints\").scrollTop());\r\n        $(\"#hoverInfo\").hide();\r\n        $(\".storyPoint\").removeClass(\"selection\");\r\n        $(\".storyPoint\").each(function(){\r\n            if ($(this).data(\"attributes\") === event.graphic.attributes){\r\n                $(this).addClass(\"selection\");\r\n                if($(this).position().top < 0){\r\n                    $(\"#storyPoints\").scrollTop(scrollTop + $(this).position().top);\r\n                }\r\n                else if($(this).position().top +$(this).height() > $(\"#storyPoints\").height()){\r\n                    $(\"#storyPoints\").scrollTop($(\"#storyPoints\").scrollTop() + $(this).position().top - $(\"#storyPoints\").height() + $(this).height());\r\n                }\r\n            }\r\n        });\r\n    });\r\n\t$(\".storyPoint\").mouseover(function(e) {\r\n        $(\".storyPoint\").removeClass('active');\r\n\t\t$(this).addClass('active');\r\n        if (popupOpen == false){\r\n    \t\t$(\"#hoverInfo\").html($(this).data('title'));\r\n\t\t\tvar pt = _maps[index].toScreen($(this).data('geometry'));\r\n\t\t\thoverInfoPos(pt.x,pt.y);\r\n\t\t\tvar attr = $(this).data('attributes');\r\n\t\t\tdojo.forEach(_storyPoints,function (lyr,idx){\r\n\t\t\t\tdojo.forEach(lyr.graphics,function(graphic,ix){\r\n\t\t\t\t\tif (graphic.attributes == attr){\r\n\t\t\t\t\t\tgraphic.setSymbol(graphic.symbol.setHeight(34).setWidth(27).setOffset(3,10));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n    });\r\n\t$(\".storyPoint\").click(function(e) {\r\n        popupOpen = true;\r\n        $(\".storyPoint\").removeClass(\"selection\");\r\n        $(this).addClass(\"selection\");\r\n\t\t_popup[index].show($(this).data('geometry'));\r\n\t\tif(_maps[j].extent.contains($(this).data('geometry')) == false){\r\n\t\t\tpanMap($(this).data('geometry'));\r\n\t\t}\r\n\t\tvar attr = $(this).data('attributes');\r\n\t\tdojo.forEach(_storyPoints,function (lyr,idx){\r\n\t\t\tdojo.forEach(lyr.graphics,function(graphic,ix){\r\n\t\t\t\tif (graphic.attributes == attr){\r\n\t\t\t\t\t_popup[index].setFeatures([graphic]);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n        $(\"#hoverInfo\").hide();\r\n    });\r\n\t$(\"#storyPoints\").mouseout(function(e) {\r\n        $(\".storyPoint\").removeClass('active');\r\n        $(\"#hoverInfo\").hide();\r\n        dojo.forEach(_storyPoints,function (lyr,idx){\r\n    \t\tdojo.forEach(lyr.graphics,function(graphic,ix){\r\n\t\t\t\tgraphic.setSymbol(graphic.symbol.setHeight(28).setWidth(22).setOffset(3,8));\r\n\t\t\t});\r\n\t\t});\r\n    });\r\n\r\n\t$(\".tab\").click(function(e) {\r\n        j = $(this).data(\"count\");\r\n\t\t$(\".tab\").removeClass('selectedStory');\r\n\t\t$(this).addClass('selectedStory');\r\n\t\t$(\".mapDiv\").hide();\r\n\t\t$(\".story\").hide();\r\n\t\t$(\".legendDiv\").hide();\r\n\t\t$(\"#mapDiv\"+j).show();\r\n\t\t$(\"#story\"+j).show();\r\n\t\t$(\"#legendDiv\"+j).show();\r\n\t\tdojo.byId(\"title\").innerHTML = configOptions.title || _mapInfo[j].title || \"\";\r\n        dojo.byId(\"subtitle\").innerHTML = configOptions.subtitle|| _mapInfo[j].subtitle || \"\";\r\n\t\tdojo.byId(\"description\").innerHTML = configOptions.description|| _mapInfo[j].description || \"\";\r\n    });\r\n}\r\n\r\nfunction panMap(pt){\r\n\tvar ext = _maps[j].extent;\r\n\tvar height = ext.getHeight();\r\n\tvar width = ext.getWidth();\r\n\tif (pt.x < ext.xmin && pt.y > ext.ymax){\r\n\t\tvar xmin = (pt.x - (width/5));\r\n\t\tvar xmax = (pt.x - (width/5) + width);\r\n\t\tvar ymax = (pt.y + (height/5));\r\n\t\tvar ymin =(pt.y + (height/5) - height);\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.x > ext.xmax && pt.y > ext.ymax){\r\n\t\tvar xmin = (pt.x + (width/5) - width);\r\n\t\tvar xmax = (pt.x + (width/5));\r\n\t\tvar ymax = (pt.y + (height/5));\r\n\t\tvar ymin =(pt.y + (height/5) - height);\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.x > ext.xmax && pt.y < ext.ymin){\r\n\t\tvar xmin = (pt.x + (width/5) - width);\r\n\t\tvar xmax = (pt.x + (width/5));\r\n\t\tvar ymax = (pt.y - (height/5) + height);\r\n\t\tvar ymin =(pt.y - (height/5));\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.x < ext.xmin && pt.y < ext.ymin){\r\n\t\tvar xmin = (pt.x - (width/5));\r\n\t\tvar xmax = (pt.x - (width/5) + width);\r\n\t\tvar ymax = (pt.y - (height/5) + height);\r\n\t\tvar ymin =(pt.y - (height/5));\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.x < ext.xmin){\r\n\t\tvar xmin = (pt.x - (width/5));\r\n\t\tvar xmax = (pt.x - (width/5) + width);\r\n\t\tvar ymax = ext.ymax;\r\n\t\tvar ymin = ext.ymin;\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.x > ext.xmax){\r\n\t\tvar xmin = (pt.x + (width/5) - width);\r\n\t\tvar xmax = (pt.x + (width/5));\r\n\t\tvar ymax = ext.ymax;\r\n\t\tvar ymin = ext.ymin;\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.y > ext.ymax){\r\n\t\tvar xmin = ext.xmin;\r\n\t\tvar xmax = ext.xmax;\r\n\t\tvar ymax = (pt.y + (height/5));\r\n\t\tvar ymin =(pt.y + (height/5) - height);\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n\telse if (pt.y < ext.ymin){\r\n\t\tvar xmin = ext.xmin;\r\n\t\tvar xmax = ext.xmax;\r\n\t\tvar ymax = (pt.y - (height/5) + height);\r\n\t\tvar ymin =(pt.y - (height/5));\r\n\t\t_maps[j].setExtent(new esri.geometry.Extent({\"xmin\":xmin,\"ymin\":ymin,\"xmax\":xmax,\"ymax\":ymax,\r\n  \"spatialReference\":{\"wkid\":102100}}));\r\n\t}\r\n}\r\n\r\nfunction hoverInfoPos(x,y){\r\n    if (x <= ($(\"#map\").width())-230){\r\n\t\t$(\"#hoverInfo\").css(\"left\",x+15);\r\n\t}\r\n\telse{\r\n\t\t$(\"#hoverInfo\").css(\"left\",x-25-($(\"#hoverInfo\").width()));\r\n\t}\r\n\tif (y >= ($(\"#hoverInfo\").height())+50){\r\n\t\t$(\"#hoverInfo\").css(\"top\",y-35-($(\"#hoverInfo\").height()));\r\n\t}\r\n\telse{\r\n\t\t$(\"#hoverInfo\").css(\"top\",y-15+($(\"#hoverInfo\").height()));\r\n\t}\r\n\t$(\"#hoverInfo\").show();\r\n}"]],"start1":0,"start2":0,"length1":0,"length2":12584}]],"length":12584}
